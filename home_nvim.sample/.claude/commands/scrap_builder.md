# スクラップ＆ビルド

このコマンドは、反復的な実装作業（スクラップ＆ビルド）のN回目を実行します。
なお前回以前のコードを**引き継がない前提**でのスクラップ＆ビルドを想定している。

## 用語定義

- **{base}**: 元となるブランチ名（例: feature/auth など）
- **{n}**: 実行回数（1, 2, 3...）
- **{task}**: 作業内容を表す（英単語）。指定なしも有。作業ブランチのサフィックス（例: feature/auth-test-times-1, issue/0001-times-3）
- **{times-n}**: N回目を表す。作業ブランチのサフィックス（例: feature/auth-times-1, issue/0001-test-times-3）

## ファイル構造

```
.claude/works/
├── dictionary.md     # プロジェクト独自の語句整理
├── commons.md        # プロジェクト全体の共通知識
├── commons-{task}.md # 各タスク別の共通知識（例: test.md, model.md）
└── {base}/           # ブランチ別ディレクトリ
    ├── issue.md      # ブランチのイシュー・蓄積された共通知識・未決定議題のまとめ
    └── times-{n}.md  # N回目の作業記録
```

## 実行手順

### 1. 引数処理

引数がtaskを指し示す場合は、それが本コマンドの作業範囲や内容を表す。
- 例: "test"=>test, "画面のテストを充実させて"=>test
- 解釈不能であればtask指定なしと自由に判断すること。例: "進めて"=>解釈不能のため特に指定なし

### 2. 初期状態の確認と作業ブランチの準備

現在のブランチを確認（`git rev-parse --abbrev-ref HEAD`）し、以下のルールで処理：

1. 現在のブランチが `{base}-times-{n}` 形式の場合：
   - {base}と{n}を抽出
   - 次回作業のため n = n + 1 とする
   - basedir はbaseの`/`は`-`で置換する
     - 例: `feat/001/test`のとき`feat-001-test`がbasedir
2. `main`や`develop`などの汎用ブランチの場合：
   - 実行を停止しユーザーに専用ブランチをきるように伝達
3. それ以外のブランチの場合：
   - 現在のブランチを{base}とする
   - n = 1 とする（初回実行）
   - basedir はbaseの`/`は`-`で置換する
     - 例: `feat/001/test`のとき`feat-001-test`がbasedir
   - 引数でタスク内容が指定されていれば、それを`.claude/works/{basedir}/issue.md`に追記

作業ブランチの準備：
- 現在のブランチが `{base}-times-{任意の数}` 形式の場合、{base}ブランチにチェックアウト
- `{base}-times-{n}` ブランチを作成してチェックアウト

### 3. 引継ぎ資料の読み込み

以下の順序で読み込み（存在しない場合はスキップ）：
1. `.claude/works/{basedir}/issue.md` - 現ブランチのイシューおよび積み重ねた設計
2. `.claude/works/commons.md` - プロジェクト全体の共通事項
3. `.claude/works/commons-{task}.md` - task単位の共通事項、後のステップで必要に応じて読み込み

原則として過去の作業ブランチがあっても直接見ずに引継ぎ資料をもとにする。

### 4. ステップごとの作業実施

イシューをもとに作業計画を立案し、ステップごとに実行する。task指定があれば該当する作業のみをステップに切り出すこと。

作業報告書：
`.claude/works/{basedir}/times-{n}.md`に順次末尾追加すること。

各ステップは下記の流れを厳守：
1. 該当するtaskを定める
2. 該当する`.claude/works/commons-{task}.md`があれば念入りに読み込む
3. 作業報告書の末尾に`## 実施ステップ`を事前記録
4. 作業を実施
5. ステップ完了ごとにコミット（メッセージ: `{task}: ステップ名`）
6. 作業報告書の末尾に`## 議案と判断`を事後記録

```markdown
## 実施ステップ
**[ステップ名]** ({task})

- 方針と内容: [説明]
- 注意事項: [本ステップで認識している注意事項を列挙]
```

```markdown
## 議案
### [判断が必要な事項]
- 選択肢: [A], [B], [C]
- 選択: **[B]**
- 理由: [選択理由]
```

### 5. 完了報告

1. イシューの更新と整理

今回の実施内容を踏まえイシューに反映する：
- データ設計
- 画面設計
- 機能設計
- 知見や教訓
  - 特に続いていく回で以前の回に逆戻りしないように必要
- 未決定の議題

2. 実施内容のサマリーを表示
3. 議案があれば、その内容をユーザーに報告

### 6. フィードバックの整理

フィードバックに基づく更新と整理：
- ユーザーからフィードバックがあった場合は、適当な資料に仕様として反映する。
- ブランチ固有のものは`.claude/works/{basedir}/issue.md`
  - **コードを引き継がない前提**で、フィードバックを満たせるように記載が必要
- taskで共通、あるいは一般化できるものは`.claude/works/commons-{task}.md`
- 全体で共通、あるいは一般化できるものは`.claude/works/commons.md`

## 引継ぎ資料のコミット除外

以下のファイルは引継ぎ資料のため、各作業ブランチでコミットしない：
- `.claude/works/commons.md`
- `.claude/works/commons-{task}.md`
- `.claude/works/{basedir}/issue.md`

また以下のファイルも引き継ぐためコミットしない：
- `.claude/settings.local.json`

## 使用例

```
/scrap_builder # 現在のブランチ・状態からイシューに対応する作業を実施
/scrap_builder "ユーザー認証機能を実装" # 初回時にタスク内容を指定
/scrap_builder "ユーザーのテーブルはusersがいい" # 2回目以降の直接フィードバック
```

