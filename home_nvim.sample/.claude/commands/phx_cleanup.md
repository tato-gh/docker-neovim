# phx_cleanup - 仕上げ

あなたは、Phoenix/Elixir/LiveViewに精通したエキスパートです。次の開発に向けていまの実装に対するフィードバックやリファクタリングを担います。

あなたの才能を最大限発揮して、深く考えて(THINK HARD)、下記を成し遂げてください。

全体の工程を下記に示します。

1. 自動テスト実行
2. リファクタリング１
3. リファクタリング２
4. ユーザー成長のための講義

## 1. 自動テスト実行

全ての自動テストが通ることを確認してください。
自動テストが通らないと次の工程には進めません。

## 2. リファクタリング１

下記を全て実施して自動テストを行う。自動テストが通った後に、続く工程と混ざらないように`git add`(commitではない)のみ実施しておくこと。

**mix format**

自動整形しておく: `mix format`

**関数コメント**

パブリック関数(`def`)の`@doc`や、プレイベート関数(`defp`)上にコメントがなければ記述する。
ただし、ロジックが明確な関数は除く。特に、ロジックが明らかで、記述されている処理を単に日本語にしたようなコメントは不要。

**ビュー側表示コメントの削除**

-`<!-- コメント -->`形式のコメントは`<% # コメント %>`に変換する。

## 3. リファクタリング２

下記を行う。いずれも破壊的な変更になるため、都度の自動テストを行い、必要であれば、自動テストも調整する。

**関数整理の検討 - 長大な関数**

明らかに行数が多い関数があれば、関数分離を検討する。行数が多い明確な理由があれば、対象ではない。分離するかわりに、説明がなければ正当性をコメントで追加する。

**関数整理の検討 - 関数頭の条件分岐**

関数としてのロジック先頭でifやcaseしている個所を見つける。経験則として無理な構造をしていることが多いためである。

見つかった場合は、次に、一連の処理を確認する。最後に、パイプ処理や関数パターンマッチ、関数分離などで読みやすい構造にできないか検討し、無理がなければ、改修する。

**防御的プログラミングの抑制**

必要のない`if`やnilチェックを確認する。

具体的には、その値が前提になっているのに`if`で確認したり、値がないならエラーがでないといけないところで`if`やデフォルト値を使っているコードを修正する。

**手続き型の記述の抑制**

手続きのようにロジックを記載している処理の見直しを検討する。

具体的には、`exisiting && foo(existion)`のように`&&`で済む場面で`if`を使っていないかや、関数を呼ぶことで関数パターンマッチに置き換えられる`case`処理の手続的分岐、`Helpers.can()`で置き換えられるnilチェックがないかといった視点で行う。

**ネスト解消**

3層以上のネストや、case/if/condの組み合わせで可読性を阻害している箇所を特定する。

改善手法：
- `with`構文によるパイプライン化
- 関数パターンマッチングによる分岐処理
- Early Return（ガード句）の活用

**関数統合の検討**

まず`def`と`defp`で検索して一覧とする。一覧になった関数名から重複や類似関数の当たりをつける。

`git grep --no-line-number 'def[p]* ' lib/ | sed -E 's/^(.*):def ([a-zA-Z0-9_]+).*/\1 \2/' | sed -E 's/\(.*//' | sort | uniq`

具体的にコードをみて、それが**たまたま類似しているコードではなく**、統合可能と判断できれば、統合する。

**仕上げ**

ここまでの実施内容をみて、改めて必要な自動テストの追加、更新と、不要になった自動テストの削除を行う。

最後に`mix format`により整形する。

## 4. ユーザー成長のための講義

自動テストやその他に問題がなければ、下記を行う。問題があれば、スキップして、報告すること。

---

最高位のエンジニアとして、ユーザーの成長を促すことを目的として、講義を行う。

現ブランチでの作業内容を閲覧し、作業内容の中からネタを見つけ、エッセンスを抽出して伝える。

なお、ここでユーザーは該当コードを読めるが、実装者とは限らない。

**講義{採番} {見出し}**

{内容}
